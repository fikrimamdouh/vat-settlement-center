# دليل استخدام الميزات الجديدة - مركز تسوية ضريبة القيمة المضافة

## نظرة عامة

تم تحديث نظام مركز تسوية ضريبة القيمة المضافة بميزات جديدة تجعل العمل أكثر سهولة وأماناً. هذا الدليل يشرح كيفية استخدام الميزات الجديدة.

---

## الميزات الجديدة

### 1. الحفظ التلقائي (Auto-Save)

#### ما هو الحفظ التلقائي؟
النظام الآن يحفظ جميع البيانات التي تدخلها تلقائياً في متصفحك، بحيث لا تفقد أي بيانات حتى لو أغلقت المتصفح بالخطأ أو انقطع الإنترنت.

#### كيف يعمل؟
- **الحفظ التلقائي**: يتم الحفظ تلقائياً بعد ثانيتين من آخر تعديل تقوم به
- **التحميل التلقائي**: عند فتح الصفحة، يتم تحميل البيانات المحفوظة تلقائياً
- **حفظ منفصل**: كل سنة وربع لها بيانات منفصلة

#### مثال عملي:
1. افتح الصفحة واختر السنة **2025** والربع **الأول**
2. أدخل بعض البيانات في الجدول
3. انتظر ثانيتين - سيتم الحفظ تلقائياً
4. أغلق المتصفح
5. افتح الصفحة مرة أخرى واختر نفس السنة والربع
6. ستجد جميع البيانات كما تركتها!

#### ملاحظات مهمة:
- البيانات محفوظة في متصفحك فقط (localStorage)
- إذا قمت بمسح بيانات المتصفح، ستفقد البيانات المحفوظة
- لذلك، يُنصح بتصدير نسخة احتياطية بشكل دوري

---

### 2. دعم تنسيق polaris.json الجديد

#### ما الجديد؟
النظام الآن يدعم قراءة ملفات النسخ الاحتياطية بتنسيق **polaris.json** الجديد، والذي يحتوي على بيانات عدة أرباع في ملف واحد.

#### التنسيق القديم:
```json
{
  "inputs": {...},
  "newEntities": [...]
}
```

#### التنسيق الجديد:
```json
{
  "vat_data_2025_Q1": "{...}",
  "vat_data_2025_Q2": "{...}",
  "vat_data_2025_Q3": "{...}",
  "vat_data_2025_Q4": "{...}"
}
```

#### كيفية الاستخدام:
1. اضغط على زر **"استيراد البيانات"**
2. اختر ملف polaris.json
3. النظام سيتعرف تلقائياً على نوع الملف
4. سيتم قراءة البيانات للسنة والربع المختارين حالياً

#### مثال:
- إذا كنت في السنة **2025** والربع **الثاني**
- وقمت باستيراد ملف يحتوي على `vat_data_2025_Q2`
- سيتم تحميل بيانات الربع الثاني فقط

---

### 3. دمج النسخ الاحتياطية (Merge Instead of Replace)

#### ما هو الدمج؟
في السابق، عند استيراد ملف نسخة احتياطية، كان يتم استبدال جميع البيانات الموجودة. الآن، يتم **دمج** البيانات الجديدة مع البيانات الموجودة بذكاء.

#### كيف يعمل الدمج؟

##### أ. الكيانات الجديدة:
- يتم إضافة الكيانات غير الموجودة فقط
- الكيانات الموجودة لا تتأثر

**مثال:**
- لديك كيان "شركة أ" و "شركة ب"
- تستورد ملف يحتوي على "شركة ب" و "شركة ج"
- النتيجة: ستحصل على "شركة أ" و "شركة ب" (الموجودة) و "شركة ج" (الجديدة)

##### ب. المدخلات والحقول:
- الحقول الفارغة: يتم ملؤها من الملف المستورد
- الحقول المملوءة: تبقى كما هي (لا يتم استبدالها)

**مثال:**
- لديك قيمة "1000" في حقل المبيعات
- تستورد ملف يحتوي على "2000" في نفس الحقل
- النتيجة: تبقى القيمة "1000" (القيمة الموجودة لها الأولوية)

#### متى تستخدم الدمج؟
- عند دمج بيانات من مصادر متعددة
- عند استعادة بيانات قديمة دون فقدان البيانات الحالية
- عند إضافة كيانات جديدة من ملف نسخة احتياطية

---

### 4. تحديث تنسيق التصدير

#### ما الجديد؟
عند تصدير البيانات، يتم حفظ الملف بتنسيق **polaris.json** الجديد.

#### اسم الملف:
```
polaris_backup_2025-10-18.polaris.json
```

#### محتوى الملف:
```json
{
  "vat_data_2025_Q1": "{\"inputs\":{...},\"newEntities\":[...],\"return\":{...}}"
}
```

#### كيفية التصدير:
1. اضغط على زر **"تصدير البيانات"**
2. سيتم تنزيل ملف باسم `polaris_backup_YYYY-MM-DD.polaris.json`
3. الملف يحتوي على بيانات السنة والربع الحاليين فقط

#### ملاحظة مهمة:
- يُنصح بتصدير نسخة احتياطية بعد كل جلسة عمل
- احتفظ بالنسخ الاحتياطية في مكان آمن (Google Drive، Dropbox، إلخ)

---

## سيناريوهات الاستخدام

### السيناريو 1: العمل على ربع جديد
1. افتح الصفحة
2. اختر السنة والربع الجديد
3. أدخل البيانات
4. سيتم الحفظ تلقائياً
5. عند الانتهاء، اضغط "تصدير البيانات" لحفظ نسخة احتياطية

### السيناريو 2: استعادة بيانات من نسخة احتياطية
1. افتح الصفحة
2. اختر السنة والربع المطلوب
3. اضغط "استيراد البيانات"
4. اختر ملف polaris.json
5. سيتم دمج البيانات مع البيانات الموجودة

### السيناريو 3: نقل البيانات إلى جهاز آخر
1. على الجهاز الأول: اضغط "تصدير البيانات"
2. انقل الملف إلى الجهاز الثاني
3. على الجهاز الثاني: افتح الصفحة واختر نفس السنة والربع
4. اضغط "استيراد البيانات" واختر الملف
5. ستظهر جميع البيانات

### السيناريو 4: دمج بيانات من مصدرين
1. افتح الصفحة واختر السنة والربع
2. أدخل بعض البيانات يدوياً
3. اضغط "استيراد البيانات" واختر ملف نسخة احتياطية
4. سيتم دمج البيانات المستوردة مع البيانات المدخلة يدوياً
5. البيانات المدخلة يدوياً لن تتأثر

---

## الأسئلة الشائعة

### س: هل البيانات آمنة؟
**ج:** البيانات محفوظة في متصفحك فقط (localStorage)، ولا يتم إرسالها إلى أي خادم. لكن يُنصح بتصدير نسخ احتياطية بشكل دوري.

### س: ماذا يحدث إذا مسحت بيانات المتصفح؟
**ج:** ستفقد جميع البيانات المحفوظة تلقائياً. لذلك، يُنصح بتصدير نسخة احتياطية بعد كل جلسة عمل.

### س: هل يمكنني استيراد ملف نسخة احتياطية قديم؟
**ج:** نعم، النظام يدعم كلاً من التنسيق القديم والجديد.

### س: ماذا يحدث إذا استوردت ملف يحتوي على بيانات مختلفة عن البيانات الموجودة؟
**ج:** سيتم دمج البيانات بذكاء. الحقول الفارغة ستُملأ من الملف المستورد، والحقول المملوءة ستبقى كما هي.

### س: كيف أعرف أن البيانات تم حفظها تلقائياً؟
**ج:** افتح Console في المتصفح (F12)، وستجد رسالة "تم الحفظ التلقائي: vat_data_YYYY_QX" بعد كل تعديل.

### س: هل يمكنني تعطيل الحفظ التلقائي؟
**ج:** حالياً، الحفظ التلقائي مفعّل دائماً. لكن يمكنك مسح البيانات المحفوظة من localStorage يدوياً.

---

## نصائح للاستخدام الأمثل

1. **صدّر نسخة احتياطية بعد كل جلسة عمل**
2. **احتفظ بالنسخ الاحتياطية في أماكن متعددة**
3. **استخدم أسماء واضحة للملفات** (مثل: `polaris_Q1_2025_final.polaris.json`)
4. **تحقق من السنة والربع قبل الاستيراد**
5. **استخدم ميزة الدمج لإضافة بيانات جديدة دون فقدان البيانات الحالية**

---

## الدعم الفني

إذا واجهت أي مشاكل أو لديك أي استفسارات، يرجى فتح Issue في GitHub أو التواصل مع المطور.

**رابط المستودع**: https://github.com/fikrimamdouh/vat-settlement-center

---

**آخر تحديث**: أكتوبر 2025  
**الإصدار**: 2.0

