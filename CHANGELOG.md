# سجل التغييرات - مركز تسوية ضريبة القيمة المضافة

## الإصدار الجديد - التحديثات المضافة

### الميزات الجديدة

#### 1. الحفظ التلقائي (Auto-Save)
- **الوصف**: يتم حفظ جميع البيانات المدخلة تلقائياً في متصفح المستخدم (localStorage)
- **كيفية العمل**: 
  - يتم الحفظ تلقائياً بعد ثانيتين من آخر تعديل
  - يتم حفظ البيانات حسب السنة والربع المختار
  - يتم تحميل البيانات تلقائياً عند فتح الصفحة أو تغيير السنة/الربع
- **الفوائد**: 
  - عدم فقدان البيانات عند إغلاق المتصفح بالخطأ
  - الحفاظ على البيانات لكل ربع على حدة

#### 2. دعم تنسيق polaris.json الجديد
- **الوصف**: تحديث دالة الاستيراد لقراءة النسخة الجديدة من ملفات النسخ الاحتياطية
- **التنسيق الجديد**:
  ```json
  {
    "vat_data_2025_Q1": "{...}",
    "vat_data_2025_Q2": "{...}"
  }
  ```
- **التوافق**: يدعم النظام كلاً من التنسيق القديم والجديد تلقائياً

#### 3. دمج النسخ الاحتياطية (Merge Instead of Replace)
- **الوصف**: عند استيراد ملف نسخة احتياطية، يتم دمج البيانات مع البيانات الموجودة بدلاً من استبدالها
- **آلية الدمج**:
  - **الكيانات الجديدة**: يتم إضافة الكيانات غير الموجودة فقط
  - **المدخلات**: يتم تحديث الحقول الفارغة فقط، والحفاظ على البيانات الموجودة
  - **بيانات الإقرار**: نفس منطق المدخلات
- **الفوائد**: 
  - عدم فقدان البيانات الحالية
  - إمكانية دمج بيانات من مصادر متعددة

#### 4. الحفاظ على البيانات عند التحديث
- **الوصف**: البيانات المحفوظة في localStorage تبقى حتى بعد تحديث الصفحة
- **كيفية العمل**: 
  - يتم تحميل البيانات تلقائياً عند فتح الصفحة
  - يتم الحفظ التلقائي عند كل تعديل
  - البيانات مقسمة حسب السنة والربع

#### 5. تحديث تنسيق التصدير
- **الوصف**: تم تحديث اسم الملف المصدر ليكون بتنسيق polaris.json
- **الاسم الجديد**: `polaris_backup_YYYY-MM-DD.polaris.json`
- **التنسيق**: يتبع نفس تنسيق الملفات المستوردة للتوافق الكامل

### التغييرات التقنية

#### الدوال الجديدة المضافة:
1. `autoSave()` - دالة الحفظ التلقائي
2. `scheduleAutoSave()` - جدولة الحفظ التلقائي
3. `loadAutoSavedData()` - تحميل البيانات المحفوظة
4. `mergeImportedData(data)` - دمج البيانات المستوردة

#### التعديلات على الدوال الموجودة:
1. `importData(event)` - تحديث لدعم التنسيق الجديد والدمج
2. `exportData()` - تحديث لحفظ البيانات بتنسيق polaris.json

#### مستمعي الأحداث الجديدة:
1. حفظ تلقائي عند تغيير أي حقل إدخال
2. تحميل البيانات عند تغيير السنة
3. تحميل البيانات عند تغيير الربع
4. تحميل البيانات عند بدء تشغيل الصفحة

### ملاحظات الاستخدام

#### كيفية استخدام الحفظ التلقائي:
1. افتح الصفحة واختر السنة والربع
2. أدخل البيانات كالمعتاد
3. سيتم الحفظ تلقائياً بعد ثانيتين من آخر تعديل
4. عند إعادة فتح الصفحة، اختر نفس السنة والربع لاستعادة البيانات

#### كيفية استيراد ملف polaris.json:
1. اضغط على زر "استيراد البيانات"
2. اختر ملف polaris.json
3. سيتم قراءة البيانات للسنة والربع الحاليين المختارين
4. سيتم دمج البيانات مع البيانات الموجودة

#### كيفية تصدير البيانات:
1. اضغط على زر "تصدير البيانات"
2. سيتم تنزيل ملف بتنسيق `polaris_backup_YYYY-MM-DD.polaris.json`
3. يحتوي الملف على بيانات السنة والربع الحاليين فقط

### الملفات المعدلة
- `index.html` - الملف الرئيسي للتطبيق

### النسخ الاحتياطية
- `index.html.backup` - نسخة احتياطية من الملف الأصلي قبل التعديل

---

**تاريخ التحديث**: أكتوبر 2025  
**المطور**: تم التحديث بواسطة Manus AI

